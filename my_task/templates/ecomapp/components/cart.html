
{% extends '../base.html' %}
{% load static %}

{% block title %}Cart Item{% endblock %}

{% block content %}
<div class="container p-5">
    <h2>Your Shopping Cart</h2>

    {% if products %}
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Product</th>
                <th>Quantity</th>
                <th>Unit Price</th>
                {% comment %} <th>Total</th> {% endcomment %}
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for item in products %}
            <tr>
                <td>{{ item.product }}</td>
                {% comment %} <td>
                    <!-- Form to update quantity -->
                    <form action="{% url 'home' %}" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="product_id" value="{{ item.product_id }}">
                        <input type="number" name="quantity" min="1" value="{{ item.quantity }}" class="form-control" style="width: 80px;">
                        <button type="submit" class="btn btn-sm btn-primary">Update</button>
                    </form>
                </td> {% endcomment %}
                <td>{{ item.quantity }}</td>
                <td>₹{{ item.amount }}</td>
                {% comment %} <td>${{ item.unit_price * item.quantity }}</td> {% endcomment %}
                <td>
                    <!-- Form to remove an item from the cart -->
                    <form action="{% url 'cart_delete' %}" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="product_id" value="{{ item.id }}">
                        <input type="submit" value="Remove" class="btn btn-sm btn-danger">
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="text-end">
        <h4>Proceed to checkout</h4>
        <h6>Total_amount: ₹{{total_price}}</h6>
        <form id="payment-form">
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
           
            <input type="hidden" id="payment-amount" value="{{total_price}}">
            <button type="button"class="btn btn-success" id="pay-button">Pay Now</button>
        </form>
    </div>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
    const csrfToken = document.querySelector("input[name='csrfmiddlewaretoken']").value;
    document.getElementById("pay-button").addEventListener("click", function() {
      const amountElement = document.getElementById("payment-amount");
      const paymentAmount = parseFloat(amountElement.value) * 100; // Convert to paise
      
      fetch("{% url 'create_order' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken
        },
        body: JSON.stringify({
          amount: paymentAmount, // Sending the amount to the backend
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          var options = {
            key: data.razorpay_key,
            amount: data.amount,
            currency: "INR",
            name: "HackerKernel",
            description: "Purchase from Cart",
            order_id: data.order_id,
            handler: function (response) {
              console.log("Payment successful", response);
              // Handle successful payment (e.g., update UI, redirect)
            },
            theme: {
              color: "#3399cc",
            },
          };
    
          var rzp = new Razorpay(options);
          rzp.open();
        })
        .catch((error) => {
          console.error("Error creating order:", error);
        });
    });
    </script>

    {% else %}
    <p>Your cart is empty. <a href="/products">Shop now</a>.</p>
    {% endif %}
</div>
{% endblock %}